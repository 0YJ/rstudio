function method(obj,name){return function(){obj[name].apply(obj,arguments)}}var StopIteration={toString:function(){return"StopIteration"}};function forEach(iter,f){if(iter.next)try{while(true)f(iter.next())}catch(e){if(e!=StopIteration)throw e;}else for(var i=0;i<iter.length;i++)f(iter[i])}function map(iter,f){var accum=[];forEach(iter,function(val){accum.push(f(val))});return accum}function matcher(regexp){return function(value){return regexp.test(value)}}
function hasClass(element,className){var classes=element.className;return classes&&(new RegExp("(^| )"+className+"($| )")).test(classes)}function insertAfter(newNode,oldNode){var parent=oldNode.parentNode;parent.insertBefore(newNode,oldNode.nextSibling);return newNode}function removeElement(node){if(node.parentNode)node.parentNode.removeChild(node)}function clearElement(node){while(node.firstChild)node.removeChild(node.firstChild)}
function isAncestor(node,child){while(child=child.parentNode)if(node==child)return true;return false}var nbsp="\u00a0";var matching={"{":"}","[":"]","(":")","}":"{","]":"[",")":"("};
function normalizeEvent(event){if(!event.stopPropagation){event.stopPropagation=function(){this.cancelBubble=true};event.preventDefault=function(){this.returnValue=false}}if(!event.stop)event.stop=function(){this.stopPropagation();this.preventDefault()};if(event.type=="keypress"){event.code=event.charCode==null?event.keyCode:event.charCode;event.character=String.fromCharCode(event.code)}return event}
function addEventHandler(node,type,handler,removeFunc){function wrapHandler(event){handler(normalizeEvent(event||window.event))}if(typeof node.addEventListener=="function"){node.addEventListener(type,wrapHandler,false);if(removeFunc)return function(){node.removeEventListener(type,wrapHandler,false)}}else{node.attachEvent("on"+type,wrapHandler);if(removeFunc)return function(){node.detachEvent("on"+type,wrapHandler)}}}
function nodeText(node){return node.textContent||node.innerText||node.nodeValue||""}function nodeTop(node){var top=0;while(node.offsetParent){top+=node.offsetTop;node=node.offsetParent}return top}function isBR(node){var nn=node.nodeName;return nn=="BR"||nn=="br"}function isSpan(node){var nn=node.nodeName;return nn=="SPAN"||nn=="span"};var stringStream=function(source){var current="";var pos=0;var accum="";function ensureChars(){while(pos==current.length){accum+=current;current="";pos=0;try{current=source.next()}catch(e){if(e!=StopIteration)throw e;else return false}}return true}return{peek:function(){if(!ensureChars())return null;return current.charAt(pos)},next:function(){if(!ensureChars())if(accum.length>0)throw"End of stringstream reached without emptying buffer ('"+accum+"').";else throw StopIteration;return current.charAt(pos++)},
get:function(){var temp=accum;accum="";if(pos>0){temp+=current.slice(0,pos);current=current.slice(pos);pos=0}return temp},push:function(str){current=current.slice(0,pos)+str+current.slice(pos)},lookAhead:function(str,consume,skipSpaces,caseInsensitive){function cased(str){return caseInsensitive?str.toLowerCase():str}str=cased(str);var found=false;var _accum=accum,_pos=pos;if(skipSpaces)this.nextWhileMatches(/[\s\u00a0]/);while(true){var end=pos+str.length,left=current.length-pos;if(end<=current.length){found=
str==cased(current.slice(pos,end));pos=end;break}else if(str.slice(0,left)==cased(current.slice(pos))){accum+=current;current="";try{current=source.next()}catch(e){break}pos=0;str=str.slice(left)}else break}if(!(found&&consume)){current=accum.slice(_accum.length)+current;pos=_pos;accum=_accum}return found},more:function(){return this.peek()!==null},applies:function(test){var next=this.peek();return next!==null&&test(next)},nextWhile:function(test){var next;while((next=this.peek())!==null&&test(next))this.next()},
matches:function(re){var next=this.peek();return next!==null&&re.test(next)},nextWhileMatches:function(re){var next;while((next=this.peek())!==null&&re.test(next))this.next()},equals:function(ch){return ch===this.peek()},endOfLine:function(){var next=this.peek();return next==null||next=="\n"}}};var select={};
(function(){select.ie_selection=document.selection&&document.selection.createRangeCollection;function topLevelNodeAt(node,top){while(node&&node.parentNode!=top)node=node.parentNode;return node}function topLevelNodeBefore(node,top){while(!node.previousSibling&&node.parentNode!=top)node=node.parentNode;return topLevelNodeAt(node.previousSibling,top)}var fourSpaces="\u00a0\u00a0\u00a0\u00a0";select.scrollToNode=function(node,cursor){if(!node)return;var element=node,body=document.body,html=document.documentElement,
atEnd=!element.nextSibling||!element.nextSibling.nextSibling||!element.nextSibling.nextSibling.nextSibling;var compensateHack=0;while(element&&!element.offsetTop){compensateHack++;element=element.previousSibling}if(compensateHack==0)atEnd=false;if(webkit&&element&&element.offsetTop==5&&element.offsetLeft==5)return;var y=compensateHack*(element?element.offsetHeight:0),x=0,width=node?node.offsetWidth:0,pos=element;while(pos&&pos.offsetParent){y+=pos.offsetTop;if(!isBR(pos))x+=pos.offsetLeft;pos=pos.offsetParent}var scroll_x=
body.scrollLeft||html.scrollLeft||0,scroll_y=body.scrollTop||html.scrollTop||0,scroll=false,screen_width=window.innerWidth||html.clientWidth||0;if(cursor||width<screen_width){if(cursor){var off=select.offsetInNode(node),size=nodeText(node).length;if(size)x+=width*(off/size)}var screen_x=x-scroll_x;if(screen_x<0||screen_x>screen_width){scroll_x=x;scroll=true}}var screen_y=y-scroll_y;if(screen_y<0||atEnd||screen_y>(window.innerHeight||html.clientHeight||0)-50){scroll_y=atEnd?1E6:y;scroll=true}if(scroll)window.scrollTo(scroll_x,
scroll_y)};select.scrollToCursor=function(container){select.scrollToNode(select.selectionTopNode(container,true)||container.firstChild,true)};var currentSelection=null;select.snapshotChanged=function(){if(currentSelection)currentSelection.changed=true};function baseNodeAfter(node){var next=node.nextSibling;if(next){while(next.firstChild)next=next.firstChild;if(next.nodeType==3||isBR(next))return next;else return baseNodeAfter(next)}else{var parent=node.parentNode;while(parent&&!parent.nextSibling)parent=
parent.parentNode;return parent&&baseNodeAfter(parent)}}select.snapshotReplaceNode=function(from,to,length,offset){if(!currentSelection)return;function replace(point){if(from==point.node){currentSelection.changed=true;if(length&&point.offset>length)point.offset-=length;else{point.node=to;point.offset+=offset||0}}else if(select.ie_selection&&point.offset==0&&point.node==baseNodeAfter(from))currentSelection.changed=true}replace(currentSelection.start);replace(currentSelection.end)};select.snapshotMove=
function(from,to,distance,relative,ifAtStart){if(!currentSelection)return;function move(point){if(from==point.node&&(!ifAtStart||point.offset==0)){currentSelection.changed=true;point.node=to;if(relative)point.offset=Math.max(0,point.offset+distance);else point.offset=distance}}move(currentSelection.start);move(currentSelection.end)};if(select.ie_selection){function selectionNode(start){var range=document.selection.createRange();range.collapse(start);function nodeAfter(node){var found=null;while(!found&&
node){found=node.nextSibling;node=node.parentNode}return nodeAtStartOf(found)}function nodeAtStartOf(node){while(node&&node.firstChild)node=node.firstChild;return{node:node,offset:0}}var containing=range.parentElement();if(!isAncestor(document.body,containing))return null;if(!containing.firstChild)return nodeAtStartOf(containing);var working=range.duplicate();working.moveToElementText(containing);working.collapse(true);for(var cur=containing.firstChild;cur;cur=cur.nextSibling){if(cur.nodeType==3){var size=
cur.nodeValue.length;working.move("character",size)}else{working.moveToElementText(cur);working.collapse(false)}var dir=range.compareEndPoints("StartToStart",working);if(dir==0)return nodeAfter(cur);if(dir==1)continue;if(cur.nodeType!=3)return nodeAtStartOf(cur);working.setEndPoint("StartToEnd",range);return{node:cur,offset:size-working.text.length}}return nodeAfter(containing)}select.markSelection=function(){currentSelection=null;var sel=document.selection;if(!sel)return;var start=selectionNode(true),
end=selectionNode(false);if(!start||!end)return;currentSelection={start:start,end:end,changed:false}};select.selectMarked=function(){if(!currentSelection||!currentSelection.changed)return;function makeRange(point){var range=document.body.createTextRange(),node=point.node;if(!node){range.moveToElementText(document.body);range.collapse(false)}else if(node.nodeType==3){range.moveToElementText(node.parentNode);var offset=point.offset;while(node.previousSibling){node=node.previousSibling;offset+=(node.innerText||
"").length}range.move("character",offset)}else{range.moveToElementText(node);range.collapse(true)}return range}var start=makeRange(currentSelection.start),end=makeRange(currentSelection.end);start.setEndPoint("StartToEnd",end);start.select()};select.offsetInNode=function(node){var sel=document.selection;if(!sel)return 0;var range=sel.createRange(),range2=range.duplicate();try{range2.moveToElementText(node)}catch(e){return 0}range.setEndPoint("StartToStart",range2);return range.text.length};select.selectionTopNode=
function(container,start){var selection=document.selection;if(!selection)return false;var range=selection.createRange(),range2=range.duplicate();range.collapse(start);var around=range.parentElement();if(around&&isAncestor(container,around)){range2.moveToElementText(around);if(range.compareEndPoints("StartToStart",range2)==1)return topLevelNodeAt(around,container)}function moveToNodeStart(range,node){if(node.nodeType==3){var count=0,cur=node.previousSibling;while(cur&&cur.nodeType==3){count+=cur.nodeValue.length;
cur=cur.previousSibling}if(cur){try{range.moveToElementText(cur)}catch(e){return false}range.collapse(false)}else range.moveToElementText(node.parentNode);if(count)range.move("character",count)}else try{range.moveToElementText(node)}catch(e){return false}return true}var start=0,end=container.childNodes.length-1;while(start<end){var middle=Math.ceil((end+start)/2),node=container.childNodes[middle];if(!node)return false;if(!moveToNodeStart(range2,node))return false;if(range.compareEndPoints("StartToStart",
range2)==1)start=middle;else end=middle-1}if(start==0){var test1=selection.createRange(),test2=test1.duplicate();try{test2.moveToElementText(container)}catch(exception){return null}if(test1.compareEndPoints("StartToStart",test2)==0)return null}return container.childNodes[start]||null};select.focusAfterNode=function(node,container){var range=document.body.createTextRange();range.moveToElementText(node||container);range.collapse(!node);range.select()};select.somethingSelected=function(){var sel=document.selection;
return sel&&sel.createRange().text!=""};function insertAtCursor(html){var selection=document.selection;if(selection){var range=selection.createRange();range.pasteHTML(html);range.collapse(false);range.select()}}select.insertNewlineAtCursor=function(){insertAtCursor("<br>")};select.insertTabAtCursor=function(){insertAtCursor(fourSpaces)};select.cursorPos=function(container,start){var selection=document.selection;if(!selection)return null;var topNode=select.selectionTopNode(container,start);while(topNode&&
!isBR(topNode))topNode=topNode.previousSibling;var range=selection.createRange(),range2=range.duplicate();range.collapse(start);if(topNode){range2.moveToElementText(topNode);range2.collapse(false)}else{try{range2.moveToElementText(container)}catch(e){return null}range2.collapse(true)}range.setEndPoint("StartToStart",range2);return{node:topNode,offset:range.text.length}};select.setCursorPos=function(container,from,to){function rangeAt(pos){var range=document.body.createTextRange();if(!pos.node){range.moveToElementText(container);
range.collapse(true)}else{range.moveToElementText(pos.node);range.collapse(false)}range.move("character",pos.offset);return range}var range=rangeAt(from);if(to&&to!=from)range.setEndPoint("EndToEnd",rangeAt(to));range.select()};select.getBookmark=function(container){var from=select.cursorPos(container,true),to=select.cursorPos(container,false);if(from&&to)return{from:from,to:to}};select.setBookmark=function(container,mark){if(!mark)return;select.setCursorPos(container,mark.from,mark.to)}}else{function innerNode(node,
offset){while(node.nodeType!=3&&!isBR(node)){var newNode=node.childNodes[offset]||node.nextSibling;offset=0;while(!newNode&&node.parentNode){node=node.parentNode;newNode=node.nextSibling}node=newNode;if(!newNode)break}return{node:node,offset:offset}}select.markSelection=function(){var selection=window.getSelection();if(!selection||selection.rangeCount==0)return currentSelection=null;var range=selection.getRangeAt(0);currentSelection={start:innerNode(range.startContainer,range.startOffset),end:innerNode(range.endContainer,
range.endOffset),changed:false}};select.selectMarked=function(){var cs=currentSelection;function focusIssue(){if(cs.start.node==cs.end.node&&cs.start.offset==cs.end.offset){var selection=window.getSelection();if(!selection||selection.rangeCount==0)return true;var range=selection.getRangeAt(0),point=innerNode(range.startContainer,range.startOffset);return cs.start.node!=point.node||cs.start.offset!=point.offset}}if(!cs||!(cs.changed||webkit&&focusIssue()))return;var range=document.createRange();function setPoint(point,
which){if(point.node)if(point.offset==0)range["set"+which+"Before"](point.node);else range["set"+which](point.node,point.offset);else range.setStartAfter(document.body.lastChild||document.body)}setPoint(cs.end,"End");setPoint(cs.start,"Start");selectRange(range)};function selectRange(range){var selection=window.getSelection();if(!selection)return;selection.removeAllRanges();selection.addRange(range)}function selectionRange(){var selection=window.getSelection();if(!selection||selection.rangeCount==
0)return false;else return selection.getRangeAt(0)}select.selectionTopNode=function(container,start){var range=selectionRange();if(!range)return false;var node=start?range.startContainer:range.endContainer;var offset=start?range.startOffset:range.endOffset;if(window.opera&&!start&&range.endContainer==container&&range.endOffset==range.startOffset+1&&container.childNodes[range.startOffset]&&isBR(container.childNodes[range.startOffset]))offset--;if(node.nodeType==3)if(offset>0)return topLevelNodeAt(node,
container);else return topLevelNodeBefore(node,container);else if(node.nodeName.toUpperCase()=="HTML")return offset==1?null:container.lastChild;else if(node==container)return offset==0?null:node.childNodes[offset-1];else if(offset==node.childNodes.length)return topLevelNodeAt(node,container);else if(offset==0)return topLevelNodeBefore(node,container);else return topLevelNodeAt(node.childNodes[offset-1],container)};select.focusAfterNode=function(node,container){var range=document.createRange();range.setStartBefore(container.firstChild||
container);if(node&&!node.firstChild)range.setEndAfter(node);else if(node)range.setEnd(node,node.childNodes.length);else range.setEndBefore(container.firstChild||container);range.collapse(false);selectRange(range)};select.somethingSelected=function(){var range=selectionRange();return range&&!range.collapsed};select.offsetInNode=function(node){var range=selectionRange();if(!range)return 0;range=range.cloneRange();range.setStartBefore(node);return range.toString().length};select.insertNodeAtCursor=
function(node){var range=selectionRange();if(!range)return;range.deleteContents();range.insertNode(node);webkitLastLineHack(document.body);if(window.opera&&isBR(node)&&isSpan(node.parentNode)){var next=node.nextSibling,p=node.parentNode,outer=p.parentNode;outer.insertBefore(node,p.nextSibling);var textAfter="";for(;next&&next.nodeType==3;next=next.nextSibling){textAfter+=next.nodeValue;removeElement(next)}outer.insertBefore(makePartSpan(textAfter,document),node.nextSibling)}range=document.createRange();
range.selectNode(node);range.collapse(false);selectRange(range)};select.insertNewlineAtCursor=function(){select.insertNodeAtCursor(document.createElement("BR"))};select.insertTabAtCursor=function(){select.insertNodeAtCursor(document.createTextNode(fourSpaces))};select.cursorPos=function(container,start){var range=selectionRange();if(!range)return;var topNode=select.selectionTopNode(container,start);while(topNode&&!isBR(topNode))topNode=topNode.previousSibling;range=range.cloneRange();range.collapse(start);
if(topNode)range.setStartAfter(topNode);else range.setStartBefore(container);var text=range.toString();return{node:topNode,offset:text.length}};select.setCursorPos=function(container,from,to){var range=document.createRange();function setPoint(node,offset,side){if(offset==0&&node&&!node.nextSibling){range["set"+side+"After"](node);return true}if(!node)node=container.firstChild;else node=node.nextSibling;if(!node)return;if(offset==0){range["set"+side+"Before"](node);return true}var backlog=[];function decompose(node){if(node.nodeType==
3)backlog.push(node);else forEach(node.childNodes,decompose)}while(true){while(node&&!backlog.length){decompose(node);node=node.nextSibling}var cur=backlog.shift();if(!cur)return false;var length=cur.nodeValue.length;if(length>=offset){range["set"+side](cur,offset);return true}offset-=length}}to=to||from;if(setPoint(to.node,to.offset,"End")&&setPoint(from.node,from.offset,"Start"))selectRange(range)}}})();function UndoHistory(container,maxDepth,commitDelay,editor){this.container=container;this.maxDepth=maxDepth;this.commitDelay=commitDelay;this.editor=editor;this.parent=editor.parent;var initial={text:"",from:null,to:null};this.first=initial;this.last=initial;this.firstTouched=false;this.history=[];this.redoHistory=[];this.touched=[]}
UndoHistory.prototype={scheduleCommit:function(){var self=this;this.parent.clearTimeout(this.commitTimeout);this.commitTimeout=this.parent.setTimeout(function(){self.tryCommit()},this.commitDelay)},touch:function(node){this.setTouched(node);this.scheduleCommit()},undo:function(){this.commit();if(this.history.length){var item=this.history.pop();this.redoHistory.push(this.updateTo(item,"applyChain"));this.notifyEnvironment();return this.chainNode(item)}},redo:function(){this.commit();if(this.redoHistory.length){var item=
this.redoHistory.pop();this.addUndoLevel(this.updateTo(item,"applyChain"));this.notifyEnvironment();return this.chainNode(item)}},clear:function(){this.history=[];this.redoHistory=[]},historySize:function(){return{undo:this.history.length,redo:this.redoHistory.length}},push:function(from,to,lines){var chain=[];for(var i=0;i<lines.length;i++){var end=i==lines.length-1?to:this.container.ownerDocument.createElement("BR");chain.push({from:from,to:end,text:cleanText(lines[i])});from=end}this.pushChains([chain],
from==null&&to==null);this.notifyEnvironment()},pushChains:function(chains,doNotHighlight){this.commit(doNotHighlight);this.addUndoLevel(this.updateTo(chains,"applyChain"));this.redoHistory=[]},chainNode:function(chains){for(var i=0;i<chains.length;i++){var start=chains[i][0],node=start&&(start.from||start.to);if(node)return node}},reset:function(){this.history=[];this.redoHistory=[]},textAfter:function(br){return this.after(br).text},nodeAfter:function(br){return this.after(br).to},nodeBefore:function(br){return this.before(br).from},
tryCommit:function(){if(!window||!window.parent||!window.UndoHistory)return;if(this.editor.highlightDirty())this.commit(true);else this.scheduleCommit()},commit:function(doNotHighlight){this.parent.clearTimeout(this.commitTimeout);if(!doNotHighlight)this.editor.highlightDirty(true);var chains=this.touchedChains(),self=this;if(chains.length){this.addUndoLevel(this.updateTo(chains,"linkChain"));this.redoHistory=[];this.notifyEnvironment()}},updateTo:function(chains,updateFunc){var shadows=[],dirty=
[];for(var i=0;i<chains.length;i++){shadows.push(this.shadowChain(chains[i]));dirty.push(this[updateFunc](chains[i]))}if(updateFunc=="applyChain")this.notifyDirty(dirty);return shadows},notifyDirty:function(nodes){forEach(nodes,method(this.editor,"addDirtyNode"));this.editor.scheduleHighlight()},notifyEnvironment:function(){if(this.onChange)this.onChange();if(window.frameElement&&window.frameElement.CodeMirror.updateNumbers)window.frameElement.CodeMirror.updateNumbers()},linkChain:function(chain){for(var i=
0;i<chain.length;i++){var line=chain[i];if(line.from)line.from.historyAfter=line;else this.first=line;if(line.to)line.to.historyBefore=line;else this.last=line}},after:function(node){return node?node.historyAfter:this.first},before:function(node){return node?node.historyBefore:this.last},setTouched:function(node){if(node){if(!node.historyTouched){this.touched.push(node);node.historyTouched=true}}else this.firstTouched=true},addUndoLevel:function(diffs){this.history.push(diffs);if(this.history.length>
this.maxDepth)this.history.shift()},touchedChains:function(){var self=this;var nullTemp=null;function temp(node){return node?node.historyTemp:nullTemp}function setTemp(node,line){if(node)node.historyTemp=line;else nullTemp=line}function buildLine(node){var text=[];for(var cur=node?node.nextSibling:self.container.firstChild;cur&&(!isBR(cur)||cur.hackBR);cur=cur.nextSibling)if(!cur.hackBR&&cur.currentText)text.push(cur.currentText);return{from:node,to:cur,text:cleanText(text.join(""))}}var lines=[];
if(self.firstTouched)self.touched.push(null);forEach(self.touched,function(node){if(node&&(node.parentNode!=self.container||node.hackBR))return;if(node)node.historyTouched=false;else self.firstTouched=false;var line=buildLine(node),shadow=self.after(node);if(!shadow||shadow.text!=line.text||shadow.to!=line.to){lines.push(line);setTemp(node,line)}});function nextBR(node,dir){var link=dir+"Sibling",search=node[link];while(search&&!isBR(search))search=search[link];return search}var chains=[];self.touched=
[];forEach(lines,function(line){if(!temp(line.from))return;var chain=[],curNode=line.from,safe=true;while(true){var curLine=temp(curNode);if(!curLine)if(safe)break;else curLine=buildLine(curNode);chain.unshift(curLine);setTemp(curNode,null);if(!curNode)break;safe=self.after(curNode);curNode=nextBR(curNode,"previous")}curNode=line.to;safe=self.before(line.from);while(true){if(!curNode)break;var curLine=temp(curNode);if(!curLine)if(safe)break;else curLine=buildLine(curNode);chain.push(curLine);setTemp(curNode,
null);safe=self.before(curNode);curNode=nextBR(curNode,"next")}chains.push(chain)});return chains},shadowChain:function(chain){var shadows=[],next=this.after(chain[0].from),end=chain[chain.length-1].to;while(true){shadows.push(next);var nextNode=next.to;if(!nextNode||nextNode==end)break;else next=nextNode.historyAfter||this.before(end)}return shadows},applyChain:function(chain){var cursor=select.cursorPos(this.container,false),self=this;function removeRange(from,to){var pos=from?from.nextSibling:
self.container.firstChild;while(pos!=to){var temp=pos.nextSibling;removeElement(pos);pos=temp}}var start=chain[0].from,end=chain[chain.length-1].to;removeRange(start,end);for(var i=0;i<chain.length;i++){var line=chain[i];if(i>0)self.container.insertBefore(line.from,end);var node=makePartSpan(fixSpaces(line.text));self.container.insertBefore(node,end);if(cursor&&cursor.node==line.from){var cursordiff=0;var prev=this.after(line.from);if(prev&&i==chain.length-1){for(var match=0;match<cursor.offset&&
line.text.charAt(match)==prev.text.charAt(match);match++);if(cursor.offset>match)cursordiff=line.text.length-prev.text.length}select.setCursorPos(this.container,{node:line.from,offset:Math.max(0,cursor.offset+cursordiff)})}else if(cursor&&i==chain.length-1&&cursor.node&&cursor.node.parentNode!=this.container)select.setCursorPos(this.container,{node:line.from,offset:line.text.length})}this.linkChain(chain);return start}};var internetExplorer=document.selection&&window.ActiveXObject&&/MSIE/.test(navigator.userAgent);var webkit=/AppleWebKit/.test(navigator.userAgent);var safari=/Apple Computer, Inc/.test(navigator.vendor);var gecko=navigator.userAgent.match(/gecko\/(\d{8})/i);if(gecko)gecko=Number(gecko[1]);var mac=/Mac/.test(navigator.platform);var brokenOpera=window.opera&&/Version\/10.[56]/.test(navigator.userAgent);var slowWebkit=/AppleWebKit\/533/.test(navigator.userAgent);
function makeWhiteSpace(n){var buffer=[],nb=true;for(;n>0;n--){buffer.push(nb||n==1?nbsp:" ");nb^=true}return buffer.join("")}function fixSpaces(string){if(string.charAt(0)==" ")string=nbsp+string.slice(1);return string.replace(/\t/g,function(){return makeWhiteSpace(indentUnit)}).replace(/[ \u00a0]{2,}/g,function(s){return makeWhiteSpace(s.length)})}function cleanText(text){return text.replace(/\u00a0/g," ").replace(/\u200b/g,"")}
function makePartSpan(value){var text=value;if(value.nodeType==3)text=value.nodeValue;else value=document.createTextNode(text);var span=document.createElement("SPAN");span.isPart=true;span.appendChild(value);span.currentText=text;return span}function alwaysZero(){return 0}var webkitLastLineHack=webkit?function(container){var last=container.lastChild;if(!last||!last.hackBR){var br=document.createElement("BR");br.hackBR=true;container.appendChild(br)}}:function(){};
var Editor=function(){var newlineElements={P:true,DIV:true,LI:true};function asEditorLines(string){var tab=makeWhiteSpace(indentUnit);return map(string.replace(/\t/g,tab).replace(/\u00a0/g," ").replace(/\r\n?/g,"\n").split("\n"),fixSpaces)}function simplifyDOM(root,atEnd){var result=[];var leaving=true;function simplifyNode(node,top){if(node.nodeType==3){var text=node.nodeValue=fixSpaces(node.nodeValue.replace(/[\r\u200b]/g,"").replace(/\n/g," "));if(text.length)leaving=false;result.push(node)}else if(isBR(node)&&
node.childNodes.length==0){leaving=true;result.push(node)}else{for(var n=node.firstChild;n;n=n.nextSibling)simplifyNode(n);if(!leaving&&newlineElements.hasOwnProperty(node.nodeName.toUpperCase())){leaving=true;if(!atEnd||!top)result.push(document.createElement("BR"))}}}simplifyNode(root,true);return result}function traverseDOM(start){var nodeQueue=[];function pointAt(node){var parent=node.parentNode;var next=node.nextSibling;return function(newnode){parent.insertBefore(newnode,next)}}var point=null;
var afterBR=true;function insertPart(part){var text="\n";if(part.nodeType==3){select.snapshotChanged();part=makePartSpan(part);text=part.currentText;afterBR=false}else{if(afterBR&&window.opera)point(makePartSpan(""));afterBR=true}part.dirty=true;nodeQueue.push(part);point(part);return text}function writeNode(node,end){var simplified=simplifyDOM(node,end);for(var i=0;i<simplified.length;i++)simplified[i]=insertPart(simplified[i]);return simplified.join("")}function partNode(node){if(node.isPart&&node.childNodes.length==
1&&node.firstChild.nodeType==3){node.currentText=node.firstChild.nodeValue;return!/[\n\t\r]/.test(node.currentText)}return false}function next(){if(!start)throw StopIteration;var node=start;start=node.nextSibling;if(partNode(node)){nodeQueue.push(node);afterBR=false;return node.currentText}else if(isBR(node)){if(afterBR&&window.opera)node.parentNode.insertBefore(makePartSpan(""),node);nodeQueue.push(node);afterBR=true;return"\n"}else{var end=!node.nextSibling;point=pointAt(node);removeElement(node);
return writeNode(node,end)}}return{next:next,nodes:nodeQueue}}function nodeSize(node){return isBR(node)?1:node.currentText.length}function startOfLine(node){while(node&&!isBR(node))node=node.previousSibling;return node}function endOfLine(node,container){if(!node)node=container.firstChild;else if(isBR(node))node=node.nextSibling;while(node&&!isBR(node))node=node.nextSibling;return node}function time(){return(new Date).getTime()}function SearchCursor(editor,string,from,caseFold){this.editor=editor;
this.history=editor.history;this.history.commit();this.valid=!!string;this.atOccurrence=false;if(caseFold==undefined)caseFold=string==string.toLowerCase();function getText(node){var line=cleanText(editor.history.textAfter(node));return caseFold?line.toLowerCase():line}var topPos={node:null,offset:0};if(from&&typeof from=="object"&&typeof from.character=="number"){editor.checkLine(from.line);var pos={node:from.line,offset:from.character};this.pos={from:pos,to:pos}}else if(from)this.pos={from:select.cursorPos(editor.container,
true)||topPos,to:select.cursorPos(editor.container,false)||topPos};else this.pos={from:topPos,to:topPos};if(caseFold)string=string.toLowerCase();var target=string.split("\n");this.matches=target.length==1?function(reverse,node,offset){var line=getText(node),len=string.length,match;if(reverse?offset>=len&&(match=line.lastIndexOf(string,offset-len))!=-1:(match=line.indexOf(string,offset))!=-1)return{from:{node:node,offset:match},to:{node:node,offset:match+len}}}:function(reverse,node,offset){var idx=
reverse?target.length-1:0,match=target[idx],line=getText(node);var offsetA=reverse?line.indexOf(match)+match.length:line.lastIndexOf(match);if(reverse?offsetA>=offset||offsetA!=match.length:offsetA<=offset||offsetA!=line.length-match.length)return;var pos=node;while(true){if(reverse&&!pos)return;pos=reverse?this.history.nodeBefore(pos):this.history.nodeAfter(pos);if(!reverse&&!pos)return;line=getText(pos);match=target[reverse?--idx:++idx];if(idx>0&&idx<target.length-1)if(line!=match)return;else continue;
var offsetB=reverse?line.lastIndexOf(match):line.indexOf(match)+match.length;if(reverse?offsetB!=line.length-match.length:offsetB!=match.length)return;return{from:{node:reverse?pos:node,offset:reverse?offsetB:offsetA},to:{node:reverse?node:pos,offset:reverse?offsetA:offsetB}}}}}SearchCursor.prototype={findNext:function(){return this.find(false)},findPrevious:function(){return this.find(true)},find:function(reverse){if(!this.valid)return false;var self=this,pos=reverse?this.pos.from:this.pos.to,node=
pos.node,offset=pos.offset;if(node&&!node.parentNode){node=null;offset=0}function savePosAndFail(){var pos={node:node,offset:offset};self.pos={from:pos,to:pos};self.atOccurrence=false;return false}while(true){if(this.pos=this.matches(reverse,node,offset)){this.atOccurrence=true;return true}if(reverse){if(!node)return savePosAndFail();node=this.history.nodeBefore(node);offset=this.history.textAfter(node).length}else{var next=this.history.nodeAfter(node);if(!next){offset=this.history.textAfter(node).length;
return savePosAndFail()}node=next;offset=0}}},select:function(){if(this.atOccurrence){select.setCursorPos(this.editor.container,this.pos.from,this.pos.to);select.scrollToCursor(this.editor.container)}},replace:function(string){if(this.atOccurrence){var end=this.editor.replaceRange(this.pos.from,this.pos.to,string);this.pos.to=end;this.atOccurrence=false}},position:function(){if(this.atOccurrence)return{line:this.pos.from.node,character:this.pos.from.offset}}};function Editor(options){this.options=
options;window.indentUnit=options.indentUnit;this.parent=parent;var container=this.container=document.body;this.history=new UndoHistory(container,options.undoDepth,options.undoDelay,this);var self=this;if(!Editor.Parser)throw"No parser loaded.";if(options.parserConfig&&Editor.Parser.configure)Editor.Parser.configure(options.parserConfig);if(!options.readOnly&&!internetExplorer)select.setCursorPos(container,{node:null,offset:0});this.dirty=[];this.importCode(options.content||"");this.history.onChange=
options.onChange;if(!options.readOnly){if(options.continuousScanning!==false){this.scanner=this.documentScanner(options.passTime);this.delayScanning()}function setEditable(){if(document.body.contentEditable!=undefined&&internetExplorer)document.body.contentEditable="true";else document.designMode="on";if(internetExplorer&&options.height!="dynamic")document.body.style.minHeight=frameElement.clientHeight-2*document.body.offsetTop-5+"px";document.documentElement.style.borderWidth="0";if(!options.textWrapping)container.style.whiteSpace=
"nowrap"}try{setEditable()}catch(e){var focusEvent=addEventHandler(document,"focus",function(){focusEvent();setEditable()},true)}addEventHandler(document,"keydown",method(this,"keyDown"));addEventHandler(document,"keypress",method(this,"keyPress"));addEventHandler(document,"keyup",method(this,"keyUp"));function cursorActivity(){self.cursorActivity(false)}addEventHandler(internetExplorer?document.body:window,"mouseup",cursorActivity);addEventHandler(document.body,"cut",cursorActivity);if(gecko)addEventHandler(window,
"pagehide",function(){self.unloaded=true});addEventHandler(document.body,"paste",function(event){cursorActivity();var text=null;try{var clipboardData=event.clipboardData||window.clipboardData;if(clipboardData)text=clipboardData.getData("Text")||clipboardData.getData("text/plain")}catch(e){}if(text!==null){event.stop();self.replaceSelection(text);select.scrollToCursor(self.container)}});if(this.options.autoMatchParens)addEventHandler(document.body,"click",method(this,"scheduleParenHighlight"))}else if(!options.textWrapping)container.style.whiteSpace=
"nowrap"}function isSafeKey(code){return code>=16&&code<=18||code>=33&&code<=40}Editor.prototype={importCode:function(code){this.history.push(null,null,asEditorLines(code));this.history.reset()},getCode:function(){if(!this.container.firstChild)return"";var accum=[];select.markSelection();forEach(traverseDOM(this.container.firstChild),method(accum,"push"));select.selectMarked();if(webkit&&this.container.lastChild.hackBR)accum.pop();webkitLastLineHack(this.container);return cleanText(accum.join(""))},
checkLine:function(node){if(node===false||!(node==null||node.parentNode==this.container))throw parent.CodeMirror.InvalidLineHandle;},cursorPosition:function(start){if(start==null)start=true;var pos=select.cursorPos(this.container,start);if(pos)return{line:pos.node,character:pos.offset};else return{line:null,character:0}},firstLine:function(){return null},lastLine:function(){if(this.container.lastChild)return startOfLine(this.container.lastChild);else return null},nextLine:function(line){this.checkLine(line);
var end=endOfLine(line,this.container);return end||false},prevLine:function(line){this.checkLine(line);if(line==null)return false;return startOfLine(line.previousSibling)},visibleLineCount:function(){var line=this.container.firstChild;while(line&&isBR(line))line=line.nextSibling;if(!line)return false;var innerHeight=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;return Math.floor(innerHeight/line.offsetHeight)},selectLines:function(startLine,startOffset,endLine,
endOffset){this.checkLine(startLine);var start={node:startLine,offset:startOffset},end=null;if(endOffset!==undefined){this.checkLine(endLine);end={node:endLine,offset:endOffset}}select.setCursorPos(this.container,start,end);select.scrollToCursor(this.container)},lineContent:function(line){var accum=[];for(line=line?line.nextSibling:this.container.firstChild;line&&!isBR(line);line=line.nextSibling)accum.push(nodeText(line));return cleanText(accum.join(""))},setLineContent:function(line,content){this.history.commit();
this.replaceRange({node:line,offset:0},{node:line,offset:this.history.textAfter(line).length},content);this.addDirtyNode(line);this.scheduleHighlight()},removeLine:function(line){var node=line?line.nextSibling:this.container.firstChild;while(node){var next=node.nextSibling;removeElement(node);if(isBR(node))break;node=next}this.addDirtyNode(line);this.scheduleHighlight()},insertIntoLine:function(line,position,content){var before=null;if(position=="end")before=endOfLine(line,this.container);else for(var cur=
line?line.nextSibling:this.container.firstChild;cur;cur=cur.nextSibling){if(position==0){before=cur;break}var text=nodeText(cur);if(text.length>position){before=cur.nextSibling;content=text.slice(0,position)+content+text.slice(position);removeElement(cur);break}position-=text.length}var lines=asEditorLines(content);for(var i=0;i<lines.length;i++){if(i>0)this.container.insertBefore(document.createElement("BR"),before);this.container.insertBefore(makePartSpan(lines[i]),before)}this.addDirtyNode(line);
this.scheduleHighlight()},selectedText:function(){var h=this.history;h.commit();var start=select.cursorPos(this.container,true),end=select.cursorPos(this.container,false);if(!start||!end)return"";if(start.node==end.node)return h.textAfter(start.node).slice(start.offset,end.offset);var text=[h.textAfter(start.node).slice(start.offset)];for(var pos=h.nodeAfter(start.node);pos!=end.node;pos=h.nodeAfter(pos))text.push(h.textAfter(pos));text.push(h.textAfter(end.node).slice(0,end.offset));return cleanText(text.join("\n"))},
replaceSelection:function(text){this.history.commit();var start=select.cursorPos(this.container,true),end=select.cursorPos(this.container,false);if(!start||!end)return;end=this.replaceRange(start,end,text);select.setCursorPos(this.container,end);webkitLastLineHack(this.container)},cursorCoords:function(start){var sel=select.cursorPos(this.container,start);if(!sel)return null;var off=sel.offset,node=sel.node,self=this;function measureFromNode(node,xOffset){var y=-(document.body.scrollTop||document.documentElement.scrollTop||
0),x=-(document.body.scrollLeft||document.documentElement.scrollLeft||0)+xOffset;forEach([node,window.frameElement],function(n){while(n){x+=n.offsetLeft;y+=n.offsetTop;n=n.offsetParent}});return{x:x,y:y,yBot:y+node.offsetHeight}}function withTempNode(text,f){var node=document.createElement("SPAN");node.appendChild(document.createTextNode(text));try{return f(node)}finally{if(node.parentNode)node.parentNode.removeChild(node)}}while(off){node=node?node.nextSibling:this.container.firstChild;var txt=nodeText(node);
if(off<txt.length)return withTempNode(txt.substr(0,off),function(tmp){tmp.style.position="absolute";tmp.style.visibility="hidden";tmp.className=node.className;self.container.appendChild(tmp);return measureFromNode(node,tmp.offsetWidth)});off-=txt.length}if(node&&isSpan(node))return measureFromNode(node,node.offsetWidth);else if(node&&node.nextSibling&&isSpan(node.nextSibling))return measureFromNode(node.nextSibling,0);else return withTempNode("\u200b",function(tmp){if(node)node.parentNode.insertBefore(tmp,
node.nextSibling);else self.container.insertBefore(tmp,self.container.firstChild);return measureFromNode(tmp,0)})},reroutePasteEvent:function(){if(this.capturingPaste||window.opera||gecko&&gecko>=20101026)return;this.capturingPaste=true;var te=window.frameElement.CodeMirror.textareaHack;parent.focus();te.value="";te.focus();var self=this;this.parent.setTimeout(function(){self.capturingPaste=false;window.focus();if(self.selectionSnapshot)window.select.setBookmark(self.container,self.selectionSnapshot);
var text=te.value;if(text){self.replaceSelection(text);select.scrollToCursor(self.container)}},10)},replaceRange:function(from,to,text){var lines=asEditorLines(text);lines[0]=this.history.textAfter(from.node).slice(0,from.offset)+lines[0];var lastLine=lines[lines.length-1];lines[lines.length-1]=lastLine+this.history.textAfter(to.node).slice(to.offset);var end=this.history.nodeAfter(to.node);this.history.push(from.node,end,lines);return{node:this.history.nodeBefore(end),offset:lastLine.length}},getSearchCursor:function(string,
fromCursor,caseFold){return new SearchCursor(this,string,fromCursor,caseFold)},reindent:function(){if(this.container.firstChild)this.indentRegion(null,this.container.lastChild)},reindentSelection:function(direction){if(!select.somethingSelected())this.indentAtCursor(direction);else{var start=select.selectionTopNode(this.container,true),end=select.selectionTopNode(this.container,false);if(start===false||end===false)return;this.indentRegion(start,end,direction)}},grabKeys:function(eventHandler,filter){this.frozen=
eventHandler;this.keyFilter=filter},ungrabKeys:function(){this.frozen="leave"},setParser:function(name,parserConfig){Editor.Parser=window[name];parserConfig=parserConfig||this.options.parserConfig;if(parserConfig&&Editor.Parser.configure)Editor.Parser.configure(parserConfig);if(this.container.firstChild){forEach(this.container.childNodes,function(n){if(n.nodeType!=3)n.dirty=true});this.addDirtyNode(this.firstChild);this.scheduleHighlight()}},keyDown:function(event){if(this.frozen=="leave"){this.frozen=
null;this.keyFilter=null}if(this.frozen&&(!this.keyFilter||this.keyFilter(event.keyCode,event))){event.stop();this.frozen(event);return}var code=event.keyCode;this.delayScanning();if(this.options.autoMatchParens)this.scheduleParenHighlight();if(code==13){if(event.ctrlKey&&!event.altKey)this.reparseBuffer();else{select.insertNewlineAtCursor();var mode=this.options.enterMode;if(mode!="flat")this.indentAtCursor(mode=="keep"?"keep":undefined);select.scrollToCursor(this.container)}event.stop()}else if(code==
9&&this.options.tabMode!="default"&&!event.ctrlKey){this.handleTab(!event.shiftKey);event.stop()}else if(code==32&&event.shiftKey&&this.options.tabMode=="default"){this.handleTab(true);event.stop()}else if(code==36&&!event.shiftKey&&!event.ctrlKey){if(this.home())event.stop()}else if(code==35&&!event.shiftKey&&!event.ctrlKey){if(this.end())event.stop()}else if(code==33&&!event.shiftKey&&!event.ctrlKey&&!gecko){if(this.pageUp())event.stop()}else if(code==34&&!event.shiftKey&&!event.ctrlKey&&!gecko){if(this.pageDown())event.stop()}else if((code==
219||code==221)&&event.ctrlKey&&!event.altKey){this.highlightParens(event.shiftKey,true);event.stop()}else if(event.metaKey&&!event.shiftKey&&(code==37||code==39)){var cursor=select.selectionTopNode(this.container);if(cursor===false||!this.container.firstChild)return;if(code==37)select.focusAfterNode(startOfLine(cursor),this.container);else{var end=endOfLine(cursor,this.container);select.focusAfterNode(end?end.previousSibling:this.container.lastChild,this.container)}event.stop()}else if((event.ctrlKey||
event.metaKey)&&!event.altKey)if(event.shiftKey&&code==90||code==89){select.scrollToNode(this.history.redo());event.stop()}else if(code==90||safari&&code==8){select.scrollToNode(this.history.undo());event.stop()}else if(code==83&&this.options.saveFunction){this.options.saveFunction();event.stop()}else if(code==86&&!mac)this.reroutePasteEvent()},keyPress:function(event){var electric=this.options.electricChars&&Editor.Parser.electricChars,self=this;if(this.frozen&&(!this.keyFilter||this.keyFilter(event.keyCode||
event.code,event))||event.code==13||event.code==9&&this.options.tabMode!="default"||event.code==32&&event.shiftKey&&this.options.tabMode=="default")event.stop();else if(mac&&(event.ctrlKey||event.metaKey)&&event.character=="v")this.reroutePasteEvent();else if(electric&&electric.indexOf(event.character)!=-1)this.parent.setTimeout(function(){self.indentAtCursor(null)},0);else if(brokenOpera)if(event.code==8){var sel=select.selectionTopNode(this.container),self=this,next=sel?sel.nextSibling:this.container.firstChild;
if(sel!==false&&next&&isBR(next))this.parent.setTimeout(function(){if(select.selectionTopNode(self.container)==next)select.focusAfterNode(next.previousSibling,self.container)},20)}else{if(event.code==46){var sel=select.selectionTopNode(this.container),self=this;if(sel&&isBR(sel))this.parent.setTimeout(function(){if(select.selectionTopNode(self.container)!=sel)select.focusAfterNode(sel,self.container)},20)}}else if(slowWebkit){var sel=select.selectionTopNode(this.container),next=sel?sel.nextSibling:
this.container.firstChild;if(sel&&next&&isBR(next)&&!isBR(sel)){var cheat=document.createTextNode("\u200b");this.container.insertBefore(cheat,next);this.parent.setTimeout(function(){if(cheat.nodeValue=="\u200b")removeElement(cheat);else cheat.nodeValue=cheat.nodeValue.replace("\u200b","")},20)}}if(webkit&&!this.options.textWrapping)setTimeout(function(){var node=select.selectionTopNode(self.container,true);if(node&&node.nodeType==3&&node.previousSibling&&isBR(node.previousSibling)&&node.nextSibling&&
isBR(node.nextSibling))node.parentNode.replaceChild(document.createElement("BR"),node.previousSibling)},50)},keyUp:function(event){this.cursorActivity(isSafeKey(event.keyCode))},indentLineAfter:function(start,direction){function whiteSpaceAfter(node){var ws=node?node.nextSibling:self.container.firstChild;if(!ws||!hasClass(ws,"whitespace"))return null;return ws}var self=this,whiteSpace=whiteSpaceAfter(start);var newIndent=0,curIndent=whiteSpace?whiteSpace.currentText.length:0;var firstText=whiteSpace?
whiteSpace.nextSibling:start?start.nextSibling:this.container.firstChild;if(direction=="keep"){if(start){var prevWS=whiteSpaceAfter(startOfLine(start.previousSibling));if(prevWS)newIndent=prevWS.currentText.length}}else{var nextChars=start&&firstText&&firstText.currentText?firstText.currentText:"";if(direction!=null&&this.options.tabMode=="shift")newIndent=direction?curIndent+indentUnit:Math.max(0,curIndent-indentUnit);else if(start)newIndent=start.indentation(nextChars,curIndent,direction);else if(Editor.Parser.firstIndentation)newIndent=
Editor.Parser.firstIndentation(nextChars,curIndent,direction)}var indentDiff=newIndent-curIndent;if(indentDiff<0)if(newIndent==0){if(firstText)select.snapshotMove(whiteSpace.firstChild,firstText.firstChild||firstText,0);removeElement(whiteSpace);whiteSpace=null}else{select.snapshotMove(whiteSpace.firstChild,whiteSpace.firstChild,indentDiff,true);whiteSpace.currentText=makeWhiteSpace(newIndent);whiteSpace.firstChild.nodeValue=whiteSpace.currentText}else if(indentDiff>0)if(whiteSpace){whiteSpace.currentText=
makeWhiteSpace(newIndent);whiteSpace.firstChild.nodeValue=whiteSpace.currentText;select.snapshotMove(whiteSpace.firstChild,whiteSpace.firstChild,indentDiff,true)}else{whiteSpace=makePartSpan(makeWhiteSpace(newIndent));whiteSpace.className="whitespace";if(start)insertAfter(whiteSpace,start);else this.container.insertBefore(whiteSpace,this.container.firstChild);select.snapshotMove(firstText&&(firstText.firstChild||firstText),whiteSpace.firstChild,newIndent,false,true)}else if(whiteSpace)select.snapshotMove(whiteSpace.firstChild,
whiteSpace.firstChild,newIndent,false);if(indentDiff!=0)this.addDirtyNode(start)},highlightAtCursor:function(){var pos=select.selectionTopNode(this.container,true);var to=select.selectionTopNode(this.container,false);if(pos===false||to===false)return false;select.markSelection();if(this.highlight(pos,endOfLine(to,this.container),true,20)===false)return false;select.selectMarked();return true},handleTab:function(direction){if(this.options.tabMode=="spaces")select.insertTabAtCursor();else this.reindentSelection(direction)},
home:function(){var cur=select.selectionTopNode(this.container,true),start=cur;if(cur===false||!(!cur||cur.isPart||isBR(cur))||!this.container.firstChild)return false;while(cur&&!isBR(cur))cur=cur.previousSibling;var next=cur?cur.nextSibling:this.container.firstChild;if(next&&next!=start&&next.isPart&&hasClass(next,"whitespace"))select.focusAfterNode(next,this.container);else select.focusAfterNode(cur,this.container);select.scrollToCursor(this.container);return true},end:function(){var cur=select.selectionTopNode(this.container,
true);if(cur===false)return false;cur=endOfLine(cur,this.container);if(!cur)return false;select.focusAfterNode(cur.previousSibling,this.container);select.scrollToCursor(this.container);return true},pageUp:function(){var line=this.cursorPosition().line,scrollAmount=this.visibleLineCount();if(line===false||scrollAmount===false)return false;scrollAmount-=2;for(var i=0;i<scrollAmount;i++){line=this.prevLine(line);if(line===false)break}if(i==0)return false;select.setCursorPos(this.container,{node:line,
offset:0});select.scrollToCursor(this.container);return true},pageDown:function(){var line=this.cursorPosition().line,scrollAmount=this.visibleLineCount();if(line===false||scrollAmount===false)return false;scrollAmount-=2;for(var i=0;i<scrollAmount;i++){var nextLine=this.nextLine(line);if(nextLine===false)break;line=nextLine}if(i==0)return false;select.setCursorPos(this.container,{node:line,offset:0});select.scrollToCursor(this.container);return true},scheduleParenHighlight:function(){if(this.parenEvent)this.parent.clearTimeout(this.parenEvent);
var self=this;this.parenEvent=this.parent.setTimeout(function(){self.highlightParens()},300)},highlightParens:function(jump,fromKey){var self=this;function highlight(node,ok){if(!node)return;if(self.options.markParen)self.options.markParen(node,ok);else{node.style.fontWeight="bold";node.style.color=ok?"#8F8":"#F88"}}function unhighlight(node){if(!node)return;if(self.options.unmarkParen)self.options.unmarkParen(node);else{node.style.fontWeight="";node.style.color=""}}if(!fromKey&&self.highlighted){unhighlight(self.highlighted[0]);
unhighlight(self.highlighted[1])}if(!window||!window.parent||!window.select)return;if(this.parenEvent)this.parent.clearTimeout(this.parenEvent);this.parenEvent=null;function paren(node){if(node.currentText){var match=node.currentText.match(/^[\s\u00a0]*([\(\)\[\]{}])[\s\u00a0]*$/);return match&&match[1]}}function forward(ch){return/[\(\[\{]/.test(ch)}var ch,cursor=select.selectionTopNode(this.container,true);if(!cursor||!this.highlightAtCursor())return;cursor=select.selectionTopNode(this.container,
true);if(!(cursor&&((ch=paren(cursor))||(cursor=cursor.nextSibling)&&(ch=paren(cursor)))))return;var className=cursor.className,dir=forward(ch),match=matching[ch];function tryFindMatch(){var stack=[],ch,ok=true;for(var runner=cursor;runner;runner=dir?runner.nextSibling:runner.previousSibling)if(runner.className==className&&isSpan(runner)&&(ch=paren(runner))){if(forward(ch)==dir)stack.push(ch);else if(!stack.length)ok=false;else if(stack.pop()!=matching[ch])ok=false;if(!stack.length)break}else if(runner.dirty||
!isSpan(runner)&&!isBR(runner))return{node:runner,status:"dirty"};return{node:runner,status:runner&&ok}}while(true){var found=tryFindMatch();if(found.status=="dirty"){this.highlight(found.node,endOfLine(found.node));found.node.dirty=false;continue}else{highlight(cursor,found.status);highlight(found.node,found.status);if(fromKey)self.parent.setTimeout(function(){unhighlight(cursor);unhighlight(found.node)},500);else self.highlighted=[cursor,found.node];if(jump&&found.node)select.focusAfterNode(found.node.previousSibling,
this.container);break}}},indentAtCursor:function(direction){if(!this.container.firstChild)return;if(!this.highlightAtCursor())return;var cursor=select.selectionTopNode(this.container,false);if(cursor===false)return;select.markSelection();this.indentLineAfter(startOfLine(cursor),direction);select.selectMarked()},indentRegion:function(start,end,direction){var current=start=startOfLine(start),before=start&&startOfLine(start.previousSibling);if(!isBR(end))end=endOfLine(end,this.container);this.addDirtyNode(start);
do{var next=endOfLine(current,this.container);if(current)this.highlight(before,next,true);this.indentLineAfter(current,direction);before=current;current=next}while(current!=end);select.setCursorPos(this.container,{node:start,offset:0},{node:end,offset:0})},cursorActivity:function(safe){if(this.unloaded){window.document.designMode="off";window.document.designMode="on";this.unloaded=false}if(internetExplorer){this.container.createTextRange().execCommand("unlink");clearTimeout(this.saveSelectionSnapshot);
var self=this;this.saveSelectionSnapshot=setTimeout(function(){var snapshot=select.getBookmark(self.container);if(snapshot)self.selectionSnapshot=snapshot},200)}var activity=this.options.cursorActivity;if(!safe||activity){var cursor=select.selectionTopNode(this.container,false);if(cursor===false||!this.container.firstChild)return;cursor=cursor||this.container.firstChild;if(activity)activity(cursor);if(!safe){this.scheduleHighlight();this.addDirtyNode(cursor)}}},reparseBuffer:function(){forEach(this.container.childNodes,
function(node){node.dirty=true});if(this.container.firstChild)this.addDirtyNode(this.container.firstChild)},addDirtyNode:function(node){node=node||this.container.firstChild;if(!node)return;for(var i=0;i<this.dirty.length;i++)if(this.dirty[i]==node)return;if(node.nodeType!=3)node.dirty=true;this.dirty.push(node)},allClean:function(){return!this.dirty.length},scheduleHighlight:function(){var self=this;this.parent.clearTimeout(this.highlightTimeout);this.highlightTimeout=this.parent.setTimeout(function(){self.highlightDirty()},
this.options.passDelay)},getDirtyNode:function(){while(this.dirty.length>0){var found=this.dirty.pop();try{while(found&&found.parentNode!=this.container)found=found.parentNode;if(found&&(found.dirty||found.nodeType==3))return found}catch(e){}}return null},highlightDirty:function(force){if(!window||!window.parent||!window.select)return false;if(!this.options.readOnly)select.markSelection();var start,endTime=force?null:time()+this.options.passTime;while((time()<endTime||force)&&(start=this.getDirtyNode())){var result=
this.highlight(start,endTime);if(result&&result.node&&result.dirty)this.addDirtyNode(result.node.nextSibling)}if(!this.options.readOnly)select.selectMarked();if(start)this.scheduleHighlight();return this.dirty.length==0},documentScanner:function(passTime){var self=this,pos=null;return function(){if(!window||!window.parent||!window.select)return;if(pos&&pos.parentNode!=self.container)pos=null;select.markSelection();var result=self.highlight(pos,time()+passTime,true);select.selectMarked();var newPos=
result?result.node&&result.node.nextSibling:null;pos=pos==newPos?null:newPos;self.delayScanning()}},delayScanning:function(){if(this.scanner){this.parent.clearTimeout(this.documentScan);this.documentScan=this.parent.setTimeout(this.scanner,this.options.continuousScanning)}},highlight:function(from,target,cleanLines,maxBacktrack){var container=this.container,self=this,active=this.options.activeTokens;var endTime=typeof target=="number"?target:null;if(!container.firstChild)return false;while(from&&
(!from.parserFromHere||from.dirty)){if(maxBacktrack!=null&&isBR(from)&&--maxBacktrack<0)return false;from=from.previousSibling}if(from&&!from.nextSibling)return false;function correctPart(token,part){return!part.reduced&&part.currentText==token.value&&part.className==token.style}function shortenPart(part,minus){part.currentText=part.currentText.substring(minus);part.reduced=true}function tokenPart(token){var part=makePartSpan(token.value);part.className=token.style;return part}function maybeTouch(node){if(node){var old=
node.oldNextSibling;if(lineDirty||old===undefined||node.nextSibling!=old)self.history.touch(node);node.oldNextSibling=node.nextSibling}else{var old=self.container.oldFirstChild;if(lineDirty||old===undefined||self.container.firstChild!=old)self.history.touch(null);self.container.oldFirstChild=self.container.firstChild}}var traversal=traverseDOM(from?from.nextSibling:container.firstChild),stream=stringStream(traversal),parsed=from?from.parserFromHere(stream):Editor.Parser.make(stream);function surroundedByBRs(node){return(node.previousSibling==
null||isBR(node.previousSibling))&&(node.nextSibling==null||isBR(node.nextSibling))}var parts={current:null,get:function(){if(!this.current)this.current=traversal.nodes.shift();return this.current},next:function(){this.current=null},remove:function(){container.removeChild(this.get());this.current=null},getNonEmpty:function(){var part=this.get();while(part&&isSpan(part)&&part.currentText=="")if(window.opera&&surroundedByBRs(part)){this.next();part=this.get()}else{var old=part;this.remove();part=this.get();
select.snapshotMove(old.firstChild,part&&(part.firstChild||part),0)}return part}};var lineDirty=false,prevLineDirty=true,lineNodes=0;forEach(parsed,function(token){var part=parts.getNonEmpty();if(token.value=="\n"){if(!isBR(part))throw"Parser out of sync. Expected BR.";if(part.dirty||!part.indentation)lineDirty=true;maybeTouch(from);from=part;part.parserFromHere=parsed.copy();part.indentation=token.indentation||alwaysZero;part.dirty=false;if(endTime==null&&part==target)throw StopIteration;if(endTime!=
null&&time()>=endTime||!lineDirty&&!prevLineDirty&&lineNodes>1&&!cleanLines)throw StopIteration;prevLineDirty=lineDirty;lineDirty=false;lineNodes=0;parts.next()}else{if(!isSpan(part))throw"Parser out of sync. Expected SPAN.";if(part.dirty)lineDirty=true;lineNodes++;if(correctPart(token,part)){part.dirty=false;parts.next()}else{lineDirty=true;var newPart=tokenPart(token);container.insertBefore(newPart,part);if(active)active(newPart,token,self);var tokensize=token.value.length;var offset=0;while(tokensize>
0){part=parts.get();var partsize=part.currentText.length;select.snapshotReplaceNode(part.firstChild,newPart.firstChild,tokensize,offset);if(partsize>tokensize){shortenPart(part,tokensize);tokensize=0}else{tokensize-=partsize;offset+=partsize;parts.remove()}}}}});maybeTouch(from);webkitLastLineHack(this.container);return{node:parts.getNonEmpty(),dirty:lineDirty}}};return Editor}();
addEventHandler(window,"load",function(){var CodeMirror=window.frameElement.CodeMirror;var e=CodeMirror.editor=new Editor(CodeMirror.options);this.parent.setTimeout(method(CodeMirror,"init"),0)});function tokenizer(source,state){function isWhiteSpace(ch){return ch!="\n"&&/^[\s\u00a0]*$/.test(ch)}var tokenizer={state:state,take:function(type){if(typeof type=="string")type={style:type,type:type};type.content=(type.content||"")+source.get();if(!/\n$/.test(type.content))source.nextWhile(isWhiteSpace);type.value=type.content+source.get();return type},next:function(){if(!source.more())throw StopIteration;var type;if(source.equals("\n")){source.next();return this.take("whitespace")}if(source.applies(isWhiteSpace))type=
"whitespace";else while(!type)type=this.state(source,function(s){tokenizer.state=s});return this.take(type)}};return tokenizer};
